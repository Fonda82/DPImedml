{% extends "base.html" %}
{% load static %}

{% block title %}Conformité RGPD | Tableau de Bord{% endblock %}

{% block extra_css %}
<style>
.gdpr-header {
    background: linear-gradient(135deg, #0C7C59 0%, #14A085 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.gdpr-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    border-left: 4px solid #0C7C59;
}

.consent-metric {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1rem;
    border-left: 3px solid #0C7C59;
}

.consent-metric.excellent {
    border-left-color: #28a745;
}

.consent-metric.good {
    border-left-color: #20c997;
}

.consent-metric.warning {
    border-left-color: #ffc107;
}

.consent-metric.danger {
    border-left-color: #dc3545;
}

.metric-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.metric-number.excellent {
    color: #28a745;
}

.metric-number.good {
    color: #20c997;
}

.metric-number.warning {
    color: #ffc107;
}

.metric-number.danger {
    color: #dc3545;
}

.metric-label {
    font-size: 0.9rem;
    color: #495057;
    font-weight: 500;
}

.consent-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.consent-granted {
    background: #d4edda;
    color: #155724;
}

.consent-revoked {
    background: #f8d7da;
    color: #721c24;
}

.consent-pending {
    background: #fff3cd;
    color: #856404;
}

.consent-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-left: 3px solid #0C7C59;
}

.consent-timestamp {
    font-size: 0.8rem;
    color: #6c757d;
}

.compliance-badge {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
}

.section-header {
    background: linear-gradient(135deg, #0C7C59, #FCD116);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px 8px 0 0;
    margin: -2rem -2rem 1.5rem -2rem;
}

.btn-gdpr {
    background: linear-gradient(135deg, #0C7C59, #14A085);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-gdpr:hover {
    background: linear-gradient(135deg, #0A6B4D, #128A73);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(12, 124, 89, 0.3);
    color: white;
}

.progress-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.2rem;
    margin: 0 auto 1rem;
}

.progress-excellent {
    background: conic-gradient(#28a745 0deg 306deg, #e9ecef 306deg 360deg);
    color: #28a745;
}

.progress-good {
    background: conic-gradient(#20c997 0deg 270deg, #e9ecef 270deg 360deg);
    color: #20c997;
}

.progress-moderate {
    background: conic-gradient(#ffc107 0deg 216deg, #e9ecef 216deg 360deg);
    color: #856404;
}

.retention-policy {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border-left: 3px solid #17a2b8;
}

.policy-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.policy-name {
    font-weight: 600;
    color: #0C7C59;
}

.policy-duration {
    background: #17a2b8;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.legal-basis {
    background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%);
    border: 1px solid #0C7C59;
    border-radius: 8px;
    color: #0C7C59;
    padding: 0.75rem;
    font-size: 0.85rem;
    margin-top: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="gdpr-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-user-shield me-3"></i>
                    Conformité RGPD
                </h1>
                <p class="mb-0 opacity-90">
                    <i class="fas fa-flag me-2"></i>Règlement Général sur la Protection des Données - Mali
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <span class="compliance-badge">
                    <i class="fas fa-check-circle me-2"></i>
                    Conformité Assurée
                </span>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- GDPR Compliance Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="consent-metric excellent">
                <div class="metric-number excellent">
                    {% if consent_stats.medical_records %}
                        {{ consent_stats.medical_records.percentage }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="metric-label">Dossiers Médicaux</div>
                <small class="text-muted">Consentements accordés</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="consent-metric good">
                <div class="metric-number good">
                    {% if consent_stats.data_processing %}
                        {{ consent_stats.data_processing.percentage }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="metric-label">Traitement Données</div>
                <small class="text-muted">Consentements actifs</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="consent-metric good">
                <div class="metric-number good">
                    {% if consent_stats.sharing_partners %}
                        {{ consent_stats.sharing_partners.percentage }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="metric-label">Partage Partenaires</div>
                <small class="text-muted">Autorisations valides</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="consent-metric warning">
                <div class="metric-number warning">
                    {% if consent_stats.research %}
                        {{ consent_stats.research.percentage }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="metric-label">Recherche Médicale</div>
                <small class="text-muted">Participations acceptées</small>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Consent Management -->
        <div class="col-lg-8 mb-4">
            <div class="gdpr-card">
                <div class="section-header">
                    <h4 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Gestion des Consentements
                    </h4>
                </div>
                
                <div class="p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Consentements Récents</h6>
                        <button class="btn btn-gdpr btn-sm" onclick="refreshConsents()">
                            <i class="fas fa-sync-alt me-1"></i>Actualiser
                        </button>
                    </div>
                    
                    {% if recent_consents %}
                    {% for consent in recent_consents %}
                    <div class="consent-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">{{ consent.patient.first_name }} {{ consent.patient.last_name }}</div>
                                <div>Type: {{ consent.get_consent_type_display }}</div>
                                <div class="consent-timestamp">
                                    Par {{ consent.granted_by.get_full_name|default:consent.granted_by.username }}
                                    le {{ consent.granted_at|date:"d/m/Y à H:i" }}
                                </div>
                                <div class="legal-basis">
                                    <strong>Base légale:</strong> {{ consent.legal_basis|truncatewords:8 }}
                                </div>
                            </div>
                            <span class="consent-badge {% if consent.granted %}consent-granted{% else %}consent-revoked{% endif %}">
                                {% if consent.granted %}
                                    <i class="fas fa-check me-1"></i>Accordé
                                {% else %}
                                    <i class="fas fa-times me-1"></i>Révoqué
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-user-check fa-3x text-success mb-3"></i>
                        <h6>Aucun consentement récent</h6>
                        <p class="text-muted">Tous les consentements sont à jour</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- GDPR Compliance Status -->
        <div class="col-lg-4 mb-4">
            <!-- Overall Compliance -->
            <div class="gdpr-card mb-3">
                <div class="section-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Statut Global RGPD
                    </h5>
                </div>
                
                <div class="p-4 text-center">
                    <div class="progress-circle progress-excellent">
                        85%
                    </div>
                    <h6>Excellente Conformité</h6>
                    <p class="text-muted small">Système entièrement conforme aux exigences RGPD</p>
                    
                    <button class="btn btn-gdpr btn-sm" onclick="generateGDPRReport()">
                        <i class="fas fa-file-alt me-1"></i>Rapport RGPD
                    </button>
                </div>
            </div>

            <!-- Rights Management -->
            <div class="gdpr-card mb-3">
                <div class="section-header">
                    <h5 class="mb-0">
                        <i class="fas fa-balance-scale me-2"></i>
                        Droits des Patients
                    </h5>
                </div>
                
                <div class="p-4">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="showDataExport()">
                            <i class="fas fa-download me-2"></i>Droit à la portabilité
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="showDataCorrection()">
                            <i class="fas fa-edit me-2"></i>Droit de rectification
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="showDataErasure()">
                            <i class="fas fa-trash me-2"></i>Droit à l'effacement
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showDataAccess()">
                            <i class="fas fa-eye me-2"></i>Droit d'accès
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="gdpr-card">
                <div class="section-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        Actions Rapides
                    </h5>
                </div>
                
                <div class="p-4">
                    <div class="d-grid gap-2">
                        <button class="btn btn-gdpr" onclick="auditGDPRCompliance()">
                            <i class="fas fa-search me-2"></i>Audit Conformité
                        </button>
                        <button class="btn btn-gdpr" onclick="exportConsentReport()">
                            <i class="fas fa-table me-2"></i>Export Consentements
                        </button>
                        <button class="btn btn-gdpr" onclick="manageRetentionPolicies()">
                            <i class="fas fa-database me-2"></i>Politiques Rétention
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Retention Policies -->
    <div class="row">
        <div class="col-12">
            <div class="gdpr-card">
                <div class="section-header">
                    <h4 class="mb-0">
                        <i class="fas fa-archive me-2"></i>
                        Politiques de Rétention des Données
                    </h4>
                </div>
                
                <div class="p-4">
                    <div class="row">
                        {% for policy in retention_policies %}
                        <div class="col-md-6 mb-3">
                            <div class="retention-policy">
                                <div class="policy-header">
                                    <div class="policy-name">
                                        <i class="fas fa-folder me-2"></i>
                                        {{ policy.get_data_type_display }}
                                    </div>
                                    <div class="policy-duration">
                                        {{ policy.retention_period_days }} jours
                                    </div>
                                </div>
                                <p class="text-muted small mb-2">{{ policy.description }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        Mis à jour: {{ policy.updated_at|date:"d/m/Y" }}
                                    </small>
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Actif
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="text-center py-4">
                                <i class="fas fa-exclamation-circle fa-3x text-warning mb-3"></i>
                                <h6>Aucune politique configurée</h6>
                                <p class="text-muted">Configurez des politiques de rétention pour assurer la conformité RGPD</p>
                                <button class="btn btn-gdpr" onclick="createRetentionPolicy()">
                                    <i class="fas fa-plus me-2"></i>Créer Politique
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GDPR Compliance Checklist -->
    <div class="row">
        <div class="col-12">
            <div class="gdpr-card">
                <div class="section-header">
                    <h4 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        Liste de Vérification RGPD
                    </h4>
                </div>
                
                <div class="p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Mesures Techniques</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Chiffrement des données sensibles
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Contrôle d'accès basé sur les rôles
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Audit trail complet
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Sauvegarde sécurisée
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Pseudonymisation des données
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Mesures Organisationnelles</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Formation du personnel
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Politiques de confidentialité
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Procédures de violation de données
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Analyse d'impact RGPD
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Registre des traitements
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshConsents() {
    showToast('Consentements actualisés', 'success');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function generateGDPRReport() {
    showToast('Génération du rapport RGPD...', 'info');
    setTimeout(() => {
        showToast('Rapport RGPD généré avec succès!', 'success');
    }, 2000);
}

function auditGDPRCompliance() {
    showToast('Audit de conformité RGPD en cours...', 'info');
    setTimeout(() => {
        showToast('Audit terminé - Conformité: 85%', 'success');
    }, 3000);
}

function exportConsentReport() {
    showToast('Export des consentements...', 'info');
    setTimeout(() => {
        showToast('Rapport exporté avec succès!', 'success');
    }, 1500);
}

function manageRetentionPolicies() {
    showToast('Fonctionnalité de gestion des politiques en développement', 'warning');
}

function showDataExport() {
    showToast('Droit à la portabilité - Export de données patient disponible', 'info');
}

function showDataCorrection() {
    showToast('Droit de rectification - Modification des données patient', 'info');
}

function showDataErasure() {
    showToast('Droit à l\'effacement - Suppression sécurisée des données', 'warning');
}

function showDataAccess() {
    showToast('Droit d\'accès - Consultation des données personnelles', 'info');
}

function createRetentionPolicy() {
    showToast('Création de politique de rétention...', 'info');
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation' : 'info'}-circle me-2"></i>
        ${message}
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Auto-refresh GDPR compliance metrics every 60 seconds
setInterval(() => {
    console.log('Auto-refreshing GDPR metrics...');
}, 60000);
</script>
{% endblock %}
</rewritten_file>
 